var myApp = angular.module('MyApp', ['ngRoute']);

myApp.config(function($routeProvider) {
    $routeProvider
    .when("/", {
        templateUrl : "templates/index.html",
        controller : "IndexController"
    })
    .when("/upload", {

        templateUrl : "templates/upload.html",
        controller : "UploadController"
    })
    .when("/gallery", {
        templateUrl : "templates/gallery.html",
        controller : "GalleryController"
    })
    .when("/gallery/:isUploading", {
        templateUrl : "templates/gallery.html",
        controller : "GalleryController"
    })
    .otherwise({redirectTo: "/"});
})

myApp.run(function($rootScope) {

    $rootScope.uploading = false;

    if (window.WebSocket && typeof(Storage) !== "undefined") {

        // console.info("websocket supported");

        var socket = io();

        socket.on('connect', function() {
            // console.log("WS connected");

            var uuid = localStorage.getItem("uuid");
            var data = {
                uuid: uuid
            };
            socket.emit('clientmeta', data);
        });

        socket.on('clientmeta', function(msg) {
            console.log("clientmeta msg: ", msg);
            localStorage.setItem("uuid", msg.uuid);
        });

        socket.on('uploadState', function(msg) {
            console.log("uploadState msg: ", msg);

            if ($rootScope.images == undefined) {
                $rootScope.images = [];
            }

            $rootScope.$apply(function() {
                $rootScope.images.unshift(msg.file);

                var filesProcessed = msg.filesProcessed;
                var filesTotal = msg.filesTotal;
                var uploadPercentage = Math.round((100 / filesTotal) * filesProcessed);

                $rootScope.uploadPercentage = uploadPercentage;
            });




            console.log($rootScope.images);
            // print_ob(msg);
        });
    }
    else {
        console.info("websocket NOT supported");
    }
});


// myApp.factory("MyException", function() {
//
//     function MyException(name, message, throwingClass) {
//         this.name = name;
//         this.message = message;
//         this.throwingClass = throwingClass;
//         this.method = method;
//     }
//
//     MyException.prototype = new Error();
//     MyException.prototype.constructor = MyException;
//
//     return MyException
//
// })

myApp.controller('GalleryController', ['$scope', '$http', '$rootScope', '$routeParams', function($scope, $http, $rootScope, $routeParams) {

    if ($routeParams.isUploading !== undefined && $rootScope.uploading) {

        $rootScope.uploadPercentage = $rootScope.uploadPercentage || 1;

        var countPercentage = setInterval(function() {
            $rootScope.$apply(function() {
                var percentageAdd = $rootScope.uploadPercentage > 40 ? 1 : 3;
                $rootScope.uploadPercentage = parseInt($rootScope.uploadPercentage) + percentageAdd;

                if ($rootScope.uploadPercentage >= 99) {
                    $rootScope.uploadPercentage = 100;
                    clearInterval(countPercentage);
                }

            });
        }, 2500);
    }

    var posting = $http({
        method: 'GET',
        url: '/gallery'
    })

    posting.then(function (response) {
        var tImages = response.data;
        if ($rootScope.images == undefined) {
            $rootScope.images = [];
        }

        if (tImages.length > $rootScope.images) {
            $rootScope.images.push.apply($rootScope.images, tImages);
        }
        // console.log("$rootScope.images: ", $rootScope.images);
    });
}])

myApp.controller('IndexController', ['$scope', function($scope) {

    $scope.test = "FooBar"

}])

myApp.controller('UploadController', ['$scope', '$rootScope', '$http', '$location', function($scope, $rootScope, $http, $location) {

    var multipart = $(".multipart-support").attr("data-multipart");
    var md = new MobileDetect(window.navigator.userAgent);

    $scope.isAndroid = md.os() == "AndroidOS" ? true : false;

    function print_ob(data) {
        var html = '<pre style="border: 1px solid red; padding: 10px;">' + JSON.stringify(data) + '</pre>'
        $("body").prepend(html);
    }

    $scope.showUploadPreview = function() {
        // $("#thumbnails img").remove();
        // var files = event.target.files;
        // var filesCount = files.length;
        // var filesShownCount = 0;
        //
        // $(".overlay").removeClass("hide");
        //
        // for (var i = 0; i < filesCount; i++) {
        //     var file = files[i];
        //     var picReader = new FileReader();
        //     picReader.addEventListener("load",function(event){
        //         var picFile = event.target;
        //         var div = document.createElement("div");
        //         div.innerHTML = "<img class='thumbnail' src='" + picFile.result + "'" + "title='preview image'/>";
        //         $("#thumbnails").append(div);
        //     });
        //     picReader.readAsDataURL(file);
        //
        //
        //     picReader.onload = function (oFREvent) {
        //         filesShownCount++
        //         if (filesShownCount >= filesCount) {
        //             $(".overlay").addClass("hide");
        //         }
        //     };
        // }
    }

    $scope.uploadForm = function() {

        $rootScope.uploading = true;

        var uploaderName = $("#uploaderName").val();
        var data = new FormData();

        data.append("uploaderName", uploaderName);

        if (!$scope.isAndroid) {
            $.each($('#userFile')[0].files, function(i, file) {
                console.log(file);
                data.append('userFile', file);
            });
        }
        else {
            var inputElementsCount = $("#uploadForm").find(".userFile").length;
            $.each($("#uploadForm").find(".userFile"), function(i, element) {
                var file = $(element)[0].files;
                if (i + 1 < inputElementsCount) {
                    data.append('userFile', file[0]);
                }
            })
        }

        var uuid = localStorage.getItem("uuid");

        if (uuid != null) {
            data.append("uuid", uuid);
        }

        var posting = $http({
            method: 'POST',
            url: '/uploaded',
            data: data,
            transformRequest: angular.identity,
            headers: { 'Content-Type': undefined},
            processData: false
        })

        posting.then(function (response) {
            // console.log(response);
        });
        $location.path( "/gallery/uploading" );
    }

}])
